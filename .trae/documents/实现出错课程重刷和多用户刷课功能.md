# 实现出错课程重刷和多用户刷课功能

## 需求分析
1. **出错课程重刷**：记录刷课过程中出错的课程，提供按钮重新刷这些课程
2. **多用户刷课**：支持在同一页面进行多个用户的刷课操作

## 实现方案

### 1. 出错课程重刷功能

#### 后端修改 (`brush_api.py`)
- 在 `BrushWorker` 类中添加 `failed_courses` 列表，用于记录出错的课程
- 在课程处理失败时，将课程信息添加到 `failed_courses` 列表
- 在任务完成时，将失败课程信息通过回调返回给前端

#### 后端修改 (`app.py`)
- 在 `SessionManager` 中添加 `failed_courses` 字段，用于存储每个会话的失败课程
- 修改 `emit_finished` 函数，接收并保存失败课程信息
- 添加新的API接口 `/api/restart-failed`，用于重新刷失败的课程

#### 前端修改 (`index.html`)
- 添加"重新刷失败课程"按钮，默认隐藏
- 在刷课完成后，如果有失败课程，显示该按钮
- 实现按钮点击事件，调用新的API接口重新刷课

### 2. 多用户刷课功能

#### 后端修改 (`app.py`)
- 确保每个会话完全隔离，不共享全局状态
- 修改 `BrushWorker` 初始化，确保每个实例使用独立的配置

#### 前端修改 (`index.html`)
- 实现用户配置卡功能，支持添加/删除多个用户配置
- 每个用户配置包含独立的token、cookie、课程ID等信息
- 为每个用户配置添加独立的刷课控制按钮
- 实现会话管理，确保每个用户的刷课任务互不干扰

## 详细实现步骤

### 1. 出错课程重刷实现

1. **修改 `brush_api.py`**：
   - 在 `BrushWorker` 类中添加 `failed_courses` 列表
   - 在课程处理失败时，将课程信息添加到列表
   - 修改 `_emit('finished')` 调用，传递失败课程信息

2. **修改 `app.py`**：
   - 在 `SessionManager` 中添加 `failed_courses` 字段
   - 修改 `emit_finished` 函数，接收并保存失败课程
   - 添加 `/api/restart-failed` API 接口

3. **修改 `index.html`**：
   - 添加"重新刷失败课程"按钮
   - 在刷课完成后显示按钮（如果有失败课程）
   - 实现按钮点击事件，调用新API

### 2. 多用户刷课实现

1. **修改 `index.html`**：
   - 添加用户配置卡管理功能
   - 支持添加/删除用户配置
   - 每个配置卡有独立的输入字段和控制按钮
   - 实现配置卡的展开/折叠功能

2. **确保后端兼容性**：
   - 验证每个会话使用独立配置
   - 确保WebSocket连接正确区分不同用户

## 预期效果

1. **出错课程重刷**：
   - 刷课完成后，前端显示失败课程数量
   - 点击"重新刷失败课程"按钮，仅刷之前失败的课程
   - 支持多次重刷，直到所有课程成功

2. **多用户刷课**：
   - 同一页面可添加多个用户配置
   - 每个用户的刷课任务独立运行
   - 支持同时刷多个用户的课程
   - 每个用户的日志和进度独立显示

## 技术要点

- 使用会话ID区分不同用户的刷课任务
- 确保后端无全局状态共享
- 前端使用动态生成的DOM元素管理多用户配置
- WebSocket连接正确关联到对应的用户会话

## 代码修改范围

- `brush_api.py`：修改 `BrushWorker` 类，添加失败课程记录
- `app.py`：添加失败课程存储和重刷API
- `index.html`：添加失败课程重刷按钮和多用户配置卡

## 实现时间

预计需要1-2小时完成所有功能实现和测试。