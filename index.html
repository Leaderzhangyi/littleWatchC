<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ·è¯¾åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 24px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f7fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-label {
            font-weight: 500;
            color: #333;
        }

        .user-value {
            color: #667eea;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 70px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f7fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #ebeef3;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ff5252;
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .logs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 500px; /* ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿé«˜åº¦ */
            overflow: hidden; /* é˜²æ­¢å®¹å™¨æœ¬èº«æº¢å‡º */
        }

        .logs-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        #logArea {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: scroll; /* ç¡®ä¿æ»šåŠ¨æ¡å§‹ç»ˆå¯è§ */
            max-height: 400px; /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œè¶…è¿‡åæ»šåŠ¨ */
            color: #333;
        }

        .log-entry {
            margin-bottom: 4px;
            word-break: break-word;
        }

        .log-success { color: #27ae60; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        .progress-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .range-control {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: end;
        }

        .range-title {
            grid-column: 1 / -1;
            font-weight: 500;
            color: #333;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }

        .config-path {
            font-size: 12px;
            color: #999;
            padding: 8px 12px;
            background: #f5f7fa;
            border-radius: 4px;
            word-break: break-all;
            margin-top: 8px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #logArea::-webkit-scrollbar {
            width: 8px;
        }

        #logArea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #logArea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #logArea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ æ™ºèƒ½åˆ·è¯¾åŠ©æ‰‹</h1>
        <p>é«˜æ•ˆä¾¿æ·çš„åœ¨çº¿è¯¾ç¨‹å­¦ä¹ åŠ©æ‰‹</p>
    </div>

    <div class="container">
        <!-- å·¦ä¾§: ç”¨æˆ·é…ç½®ç®¡ç† -->
        <div class="card">
            <div class="section-title">ï¿½ ç”¨æˆ·é…ç½®ç®¡ç†</div>
            
            <!-- æ·»åŠ ç”¨æˆ·é…ç½®æŒ‰é’® -->
            <button class="btn-primary" onclick="addUserConfig()" style="width: 100%; margin-bottom: 16px;">â• æ·»åŠ ç”¨æˆ·é…ç½®</button>
            
            <!-- ç”¨æˆ·é…ç½®å¡å®¹å™¨ -->
            <div id="userConfigsContainer"></div>
        </div>

        <!-- å³ä¾§: æ—¥å¿—å’Œè¿›åº¦ -->
        <div class="card logs-container">
            <div class="logs-title">ğŸ“‹ è¿è¡Œæ—¥å¿—</div>
            <div id="logArea"></div>

            <div class="progress-section">
                <div class="progress-label">
                    <span>è¿›åº¦</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div id="statusMessage" class="status-message" style="display: none; margin-top: 12px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        // ç”¨æˆ·é…ç½®å¡æ•°æ®
        let userConfigs = [];
        let configCounter = 0;

        // åˆå§‹åŒ–
        function init() {
            // æ·»åŠ é»˜è®¤ç”¨æˆ·é…ç½®
            addUserConfig();
        }

        // æ·»åŠ ç”¨æˆ·é…ç½®å¡
        function addUserConfig() {
            configCounter++;
            const configId = `config-${configCounter}`;
            
            const configCard = document.createElement('div');
            configCard.className = 'config-card';
            configCard.id = configId;
            configCard.style.border = '1px solid #e0e0e0';
            configCard.style.borderRadius = '8px';
            configCard.style.padding = '16px';
            configCard.style.marginBottom = '16px';
            configCard.style.background = '#fafafa';
            
            configCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; color: #333;">ç”¨æˆ·é…ç½® ${configCounter}</h3>
                    <button class="btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteUserConfig('${configId}')">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
                
                <div class="user-info" style="margin-bottom: 12px;">
                    <span class="user-label">å½“å‰ç”¨æˆ·:</span>
                    <span class="user-value" id="userInfo-${configId}">æœªç™»å½•</span>
                </div>

                <!-- é…ç½®éƒ¨åˆ† -->
                <div class="section-title" style="font-size: 14px; margin-bottom: 12px; padding-bottom: 8px;">ğŸ” è®¤è¯ä¿¡æ¯</div>
                <div class="form-group">
                    <label>X_TOKEN</label>
                    <textarea id="tokenInput-${configId}" placeholder="è¯·è¾“å…¥ X_TOKEN..."></textarea>
                </div>

                <div class="form-group">
                    <label>Cookies</label>
                    <textarea id="cookieInput-${configId}" placeholder="è¯·è¾“å…¥ Cookies..."></textarea>
                </div>

                <div class="form-group" style="display:flex; gap:8px; margin-bottom: 12px;">
                    <button class="btn-primary" style="flex:0 0 auto; padding:6px 10px; font-size: 12px;" onclick="login('${configId}')">ğŸ”‘ ç™»å½•</button>
                    <div style="align-self:center;color:#666;font-size:12px;">ï¼ˆç‚¹å‡»ç™»å½•éªŒè¯å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼‰</div>
                </div>

                <!-- è¯¾ç¨‹éƒ¨åˆ† -->
                <div class="section-title" style="font-size: 14px; margin-bottom: 12px; padding-bottom: 8px;">ğŸ“š è¯¾ç¨‹é…ç½®</div>
                <div class="form-group">
                    <label>è¯¾ç¨‹ ID</label>
                    <textarea id="courseIdInput-${configId}" placeholder="è¯·è¾“å…¥è¯¾ç¨‹IDï¼ˆå¤šä¸ªç”¨æ¢è¡Œåˆ†éš”ï¼‰..."></textarea>
                </div>

                <div class="form-group">
                    <label>é…ç½®æ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="configPathInput-${configId}" value="config.json" placeholder="ç›¸å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ config.json" />
                </div>

                <button class="btn-secondary" onclick="loadConfig('${configId}')" style="width: 100%; margin-bottom: 12px; font-size: 12px; padding: 8px;">ğŸ“‚ åŠ è½½é…ç½®æ–‡ä»¶</button>

                <!-- èŒƒå›´è®¾ç½® -->
                <div class="section-title" style="font-size: 14px; margin-bottom: 12px; padding-bottom: 8px;">ğŸ“– èŒƒå›´è®¾ç½®</div>
                
                <div class="form-group">
                    <span class="range-title" style="font-size: 13px;">ç« èŠ‚èŒƒå›´</span>
                    <div class="form-row">
                        <div>
                            <label>èµ·å§‹ç« èŠ‚</label>
                            <input type="number" id="chapterStart-${configId}" value="3" min="1">
                        </div>
                        <div>
                            <label>ç»“æŸç« èŠ‚</label>
                            <input type="number" id="chapterEnd-${configId}" value="4" min="1">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <span class="range-title" style="font-size: 13px;">å°èŠ‚èŒƒå›´</span>
                    <div class="form-row">
                        <div>
                            <label>èµ·å§‹å°èŠ‚</label>
                            <input type="number" id="subsectionStart-${configId}" value="1" min="1">
                        </div>
                        <div>
                            <label>ç»“æŸå°èŠ‚</label>
                            <input type="number" id="subsectionEnd-${configId}" value="0" min="0" title="0 è¡¨ç¤ºåˆ°æœ«å°¾">
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="button-group" style="margin-top: 12px;">
                    <button class="btn-primary" id="startBtn-${configId}" onclick="startBrush('${configId}')">â–¶ å¼€å§‹åˆ·è¯¾</button>
                    <button class="btn-danger" id="stopBtn-${configId}" onclick="stopBrush()" disabled style="display: none;">â¹ åœæ­¢</button>
                    <button class="btn-secondary" id="restartFailedBtn-${configId}" onclick="restartFailedCourses('${configId}')" disabled style="display: none;">ğŸ”„ é‡æ–°åˆ·å¤±è´¥</button>
                </div>
            `;
            
            document.getElementById('userConfigsContainer').appendChild(configCard);
            
            // æ·»åŠ åˆ°é…ç½®åˆ—è¡¨
            userConfigs.push({
                id: configId,
                configCounter: configCounter
            });
        }

        // åˆ é™¤ç”¨æˆ·é…ç½®å¡
        function deleteUserConfig(configId) {
            const configCard = document.getElementById(configId);
            if (configCard) {
                configCard.remove();
            }
            
            // ä»é…ç½®åˆ—è¡¨ä¸­ç§»é™¤
            userConfigs = userConfigs.filter(config => config.id !== configId);
        }

        // åŠ è½½é…ç½®æ–‡ä»¶
        async function loadConfig(configId) {
            try {
                const cfgPath = document.getElementById(`configPathInput-${configId}`).value || 'config.json';
                const response = await fetch(`${API_BASE}/config?path=${encodeURIComponent(cfgPath)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById(`tokenInput-${configId}`).value = data.config.X_TOKEN || '';
                    document.getElementById(`cookieInput-${configId}`).value = data.config.COOKIE || '';
                    
                    let courseIds = "1983474287572594688\n1983723370145034240";
                    if (data.config.courses && Array.isArray(data.config.courses)) {
                        courseIds = data.config.courses.map(c => c.id).join('\n');
                    }
                    document.getElementById(`courseIdInput-${configId}`).value = courseIds;

                    // åŠ è½½èŒƒå›´è®¾ç½®
                    const ranges = data.config.default_ranges || {};
                    if (ranges.chapter_range) {
                        document.getElementById(`chapterStart-${configId}`).value = ranges.chapter_range.start || 1;
                        document.getElementById(`chapterEnd-${configId}`).value = ranges.chapter_range.end || 1;
                    }
                    if (ranges.subsection_range) {
                        document.getElementById(`subsectionStart-${configId}`).value = ranges.subsection_range.start || 1;
                        document.getElementById(`subsectionEnd-${configId}`).value = ranges.subsection_range.end || 0;
                    }

                    addLog(`âœ… é…ç½®æ–‡ä»¶ ${cfgPath} åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    addLog('âŒ åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥', 'error');
                }
            } catch (error) {
                addLog(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹åˆ·è¯¾
        async function startBrush(configId) {
            const token = document.getElementById(`tokenInput-${configId}`).value.trim();
            const cookie = document.getElementById(`cookieInput-${configId}`).value.trim();
            const courseId = document.getElementById(`courseIdInput-${configId}`).value.trim();
            
            if (!token) {
                showStatus('è¯·è¾“å…¥ X_TOKEN', 'error');
                return;
            }
            if (!cookie) {
                showStatus('è¯·è¾“å…¥ Cookies', 'error');
                return;
            }
            if (!courseId) {
                showStatus('è¯·è¾“å…¥è¯¾ç¨‹ ID', 'error');
                return;
            }

            const chapterStart = parseInt(document.getElementById(`chapterStart-${configId}`).value);
            const chapterEnd = parseInt(document.getElementById(`chapterEnd-${configId}`).value);
            const subsectionStart = parseInt(document.getElementById(`subsectionStart-${configId}`).value);
            const subsectionEnd = parseInt(document.getElementById(`subsectionEnd-${configId}`).value);

            const startBtn = document.getElementById(`startBtn-${configId}`);
            const stopBtn = document.getElementById(`stopBtn-${configId}`);
            const restartBtn = document.getElementById(`restartFailedBtn-${configId}`);

            startBtn.disabled = true;
            stopBtn.style.display = 'block';
            stopBtn.disabled = false;
            restartBtn.style.display = 'none';

            addLog(`ğŸš€ ç”¨æˆ·é…ç½® ${configId.split('-')[1]} å¼€å§‹åˆ·è¯¾...`, 'info');

            try {
                const cfgPath = document.getElementById(`configPathInput-${configId}`).value || 'config.json';
                const response = await fetch(`${API_BASE}/start-brush`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        X_TOKEN: token,
                        COOKIE: cookie,
                        course_id: courseId,
                        config_path: cfgPath,
                        chapter_range: { start: chapterStart, end: chapterEnd },
                        subsection_range: { start: subsectionStart, end: subsectionEnd }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // å»ºç«‹ WebSocket è¿æ¥è·å–å®æ—¶æ—¥å¿—
                    connectWebSocket(data.session_id);
                } else {
                    addLog(`âŒ ${data.message}`, 'error');
                    startBtn.disabled = false;
                    stopBtn.style.display = 'none';
                }
            } catch (error) {
                addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                startBtn.disabled = false;
                stopBtn.style.display = 'none';
            }
        }

        // ç™»å½•éªŒè¯ï¼ˆè°ƒç”¨åç«¯ /api/loginï¼‰
        async function login(configId) {
            const token = document.getElementById(`tokenInput-${configId}`).value.trim();
            const cookie = document.getElementById(`cookieInput-${configId}`).value.trim();

            if (!token) { showStatus('è¯·è¾“å…¥ X_TOKEN', 'error'); return; }
            if (!cookie) { showStatus('è¯·è¾“å…¥ Cookies', 'error'); return; }

            addLog('ğŸ”‘ æ­£åœ¨ç™»å½•éªŒè¯...', 'info');
            try {
                const cfgPath = document.getElementById(`configPathInput-${configId}`).value || 'config.json';
                const resp = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ X_TOKEN: token, COOKIE: cookie, config_path: cfgPath })
                });
                const data = await resp.json();
                if (data.success) {
                    addLog('âœ… ç™»å½•æˆåŠŸ: ' + data.user_info, 'success');
                    document.getElementById(`userInfo-${configId}`).textContent = data.user_info;
                    showStatus('ç™»å½•æˆåŠŸ', 'success');
                } else {
                    addLog('âŒ ç™»å½•å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    showStatus('ç™»å½•å¤±è´¥', 'error');
                }
            } catch (err) {
                addLog('âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ' + err.message, 'error');
                showStatus('ç™»å½•è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        // åœæ­¢åˆ·è¯¾
        async function stopBrush() {
            try {
                const response = await fetch(`${API_BASE}/stop-brush`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog('â¹ï¸ å·²åœæ­¢åˆ·è¯¾', 'warning');
                }
            } catch (error) {
                addLog(`âŒ åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹
        async function restartFailedCourses(configId) {
            // å®ç°é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹çš„é€»è¾‘
            addLog(`ğŸ”„ å¼€å§‹é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹ï¼ˆé…ç½® ${configId.split('-')[1]}ï¼‰...`, 'info');
        }

        // å½“å‰ä¼šè¯ID
        let currentSessionId = null;
        
        // SocketIO è¿æ¥è·å–å®æ—¶æ—¥å¿—
        function connectWebSocket(sessionId) {
            currentSessionId = sessionId;
            // é¦–å…ˆå°è¯•åŠ è½½socket.ioå®¢æˆ·ç«¯åº“
            if (typeof io === 'undefined') {
                // åŠ¨æ€åŠ è½½socket.ioå®¢æˆ·ç«¯åº“
                const script = document.createElement('script');
                script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
                script.onload = () => {
                    initSocketIO(sessionId);
                };
                document.head.appendChild(script);
            } else {
                initSocketIO(sessionId);
            }
        }
        
        function initSocketIO(sessionId) {
            const socket = io('http://localhost:5000', {
                query: {
                    session_id: sessionId
                }
            });

            socket.on('connect', () => {
                addLog('ğŸ“¡ å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'info');
                // åŠ å…¥ä¼šè¯æˆ¿é—´
                socket.emit('join_session', {session_id: sessionId});
            });

            socket.on('log', (data) => {
                addLog(data.message, data.level || 'info');
            });

            socket.on('progress', (data) => {
                updateProgress(data.value);
            });

            socket.on('user_info', (data) => {
                document.getElementById('userInfo').textContent = data.user_info;
            });

            socket.on('finished', (data) => {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const restartFailedBtn = document.getElementById('restartFailedBtn');
                startBtn.disabled = false;
                stopBtn.style.display = 'none';
                
                if (data.success) {
                    showStatus(`åˆ·è¯¾å®Œæˆ! æˆåŠŸ: ${data.success_count}/${data.total}`, 'success');
                    // å¦‚æœæœ‰å¤±è´¥è¯¾ç¨‹ï¼Œæ˜¾ç¤ºé‡æ–°åˆ·è¯¾æŒ‰é’®
                    if (data.failed_courses && data.failed_courses.length > 0) {
                        restartFailedBtn.style.display = 'block';
                        restartFailedBtn.disabled = false;
                        addLog(`ğŸ”„ å‘ç° ${data.failed_courses.length} ä¸ªå¤±è´¥è¯¾ç¨‹ï¼Œå¯ä»¥ç‚¹å‡»"é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹"æŒ‰é’®é‡è¯•`, 'warning');
                    } else {
                        restartFailedBtn.style.display = 'none';
                    }
                } else {
                    showStatus('åˆ·è¯¾å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—', 'error');
                }
                socket.disconnect();
            });

            socket.on('disconnect', () => {
                addLog('ğŸ“¡ å·²æ–­å¼€è¿æ¥', 'warning');
            });

            socket.on('connect_error', (error) => {
                addLog(`âŒ SocketIO é”™è¯¯: ${error.message}`, 'error');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('restartFailedBtn').style.display = 'none';
            });
        }
        
        // é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹
        async function restartFailedCourses() {
            if (!currentSessionId) {
                showStatus('æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä¼šè¯', 'error');
                return;
            }
            
            const restartBtn = document.getElementById('restartFailedBtn');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            restartBtn.disabled = true;
            startBtn.disabled = true;
            stopBtn.style.display = 'block';
            stopBtn.disabled = false;
            
            addLog('ğŸ”„ å¼€å§‹é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹...', 'info');
            
            try {
                const chapterStart = parseInt(document.getElementById('chapterStart').value);
                const chapterEnd = parseInt(document.getElementById('chapterEnd').value);
                const subsectionStart = parseInt(document.getElementById('subsectionStart').value);
                const subsectionEnd = parseInt(document.getElementById('subsectionEnd').value);
                
                const response = await fetch(`${API_BASE}/restart-failed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        chapter_range: { start: chapterStart, end: chapterEnd },
                        subsection_range: { start: subsectionStart, end: subsectionEnd }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`âœ… å·²å¼€å§‹é‡æ–°åˆ·å¤±è´¥è¯¾ç¨‹ï¼Œä¼šè¯ID: ${data.session_id}`, 'success');
                    // å»ºç«‹ WebSocket è¿æ¥è·å–å®æ—¶æ—¥å¿—
                    connectWebSocket(data.session_id);
                } else {
                    addLog(`âŒ é‡æ–°åˆ·è¯¾å¤±è´¥: ${data.message}`, 'error');
                    restartBtn.disabled = false;
                    startBtn.disabled = false;
                    stopBtn.style.display = 'none';
                }
            } catch (error) {
                addLog(`âŒ é‡æ–°åˆ·è¯¾è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                restartBtn.disabled = false;
                startBtn.disabled = false;
                stopBtn.style.display = 'none';
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, level = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(value) {
            document.getElementById('progressFill').style.width = value + '%';
            document.getElementById('progressText').textContent = value + '%';
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => statusEl.style.display = 'none', 3000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
